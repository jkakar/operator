#!/usr/bin/env bash
#/ Usage: build-rubygem <gem-name> <gem-spec>
#/ Build the Ruby Gem as described by the given <gemspec> and push it to our
#/ internal gem server on Artifactory. This is typically only invoked on the CI
#/ server. Requires the /etc/env/artifactoryenv file to be readable and to
#/ contain the hostname and authentication credentials of the Artifactory server.
set -euo pipefail
cd "$(dirname "$0")/../../.."

. etc/buildenv

# Print usage and exit if gemspec argument is missing.
gemname="${1:-""}"
gemspec="${2:-""}"
if [ -z "$gemname" ] || [ -z "gemspec" ]; then
    grep ^#/ <"$0" |cut -c4-
    exit 2
fi

# Declare required environment variables.
: "$HOME"
: "$ARTIFACTORY_URL"
: "$ARTIFACTORY_USERNAME"
: "$ARTIFACTORY_PASSWORD"
: "$ARTIFACTORY_REPO_GEM_LOCAL"
: "$CI_PLAN"
: "$CI_BRANCH"
: "$CI_BUILD_NUMBER"

# Enable tracing if DEBUG is set.
: "${DEBUG:=""}"
test -n "$DEBUG" && set -x

# Configure RubyGems for pushing to our Artifactory repository
RUBYGEMS_HOST="${ARTIFACTORY_URL}/api/gems/${ARTIFACTORY_REPO_GEM_LOCAL}"
test -d "${HOME}/.gem" || mkdir "${HOME}/.gem"
set +x
curl -s -u "${ARTIFACTORY_USERNAME}:${ARTIFACTORY_PASSWORD}" \
    "${RUBYGEMS_HOST}/api/v1/api_key.yaml" \
    > "${HOME}/.gem/credentials"
chmod 600 "${HOME}/.gem/credentials"
test -n "$DEBUG" && set -x
export RUBYGEMS_HOST

# Determine gem version. Bamboo does not provide a build number that is global
# accross branches. So we use the build number only when building the master
# branch. Otherwise we prefix the version by 0 to make sure that non-master
# builds are never considered newer. Example versions:
#
# * Master branch: pardot_pull-agent-123
# * Topic branch: pardot-pull_agent-0.PUL36.10
#
# One consequence of including the plan key (which includes letters) in the
# version string is that it is considered a prerelease version meaning that
# installing it requires passing the "--prerelease" flag to the "gem install"
# command. See this article for more info:
#
# http://guides.rubygems.org/patterns/#prerelease-gems
# shellcheck disable=SC2154
if [ "$CI_BRANCH" = "master" ]
then RUBYGEM_VERSION="$((CI_BUILD_NUMBER))"
else RUBYGEM_VERSION="0.${CI_PLAN}.${CI_BUILD_NUMBER}"
fi
export RUBYGEM_VERSION

# Build the gem and push it to Artifactory
cd "$(dirname "$gemspec")"
gem build "$(basename "$gemspec")"
gem push "${gemname}-${RUBYGEM_VERSION}.gem"
