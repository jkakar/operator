#!/usr/bin/env bash
#/ Usage: docker-tarball-upload <git-sha1> <build-green> <tarball>
#/ Wrapper that runs 'tarball-upload' within a container.
set -euo pipefail

cd "$(dirname "$0")/../.."
. etc/build/env

gitsha1="$1"
tarball="$2"
green="$3"

docker run --rm \
  -v "$(pwd):/data" \
  -v "${tarball}:/data/tarball.tar" \
  -w "/data" \
  -e "ARTIFACTORY_HOST=$ARTIFACTORY_HOST" \
  -e "ARTIFACTORY_URL=$ARTIFACTORY_URL" \
  -e "ARTIFACTORY_USERNAME=$ARTIFACTORY_USERNAME" \
  -e "ARTIFACTORY_PASSWORD=$ARTIFACTORY_PASSWORD" \
  -e "BAMBOO_BUILD_RESULTS_URL=$BAMBOO_BUILD_RESULTS_URL" \
  -e "BAMBOO_BUILD_TIMESTAMP=$BAMBOO_BUILD_TIMESTAMP" \
  -e "CANOE_ARTIFACTORY_REPO=$ARTIFACTORY_REPO_CANOE" \
  -e "CI_PLAN=$CI_PLAN" \
  -e "CI_BUILD_NUMBER=$CI_BUILD_NUMBER" \
  -e "CI_BRANCH=$CI_BRANCH" \
  build/build \
  tarball-upload "$gitsha1" "$green" /data/tarball.tar
