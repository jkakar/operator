#!/usr/bin/env bash
#/ Usage: build [--help] <app>
#/ Deploy a BREAD app to ECS.
set -euo pipefail
cd "$(dirname "$0")/../.."

. etc/buildenv

app="${1:-}"
if [ "$#" -ne 1 ] || [ "$app" = "--help" ] || [ -z "$app" ]; then
    grep ^#/ <"$0" |cut -c4-
    exit 1
fi

cluster=
service=
image=
case "$app" in
    canoe|hal9000|parbot|teampass)
        if [ "$app" = "teampass" ]; then
            cluster="$app"
        else
            cluster="${app}_production"
        fi
        service="$app"
        image="$DOCKER_REPO_BREAD/$app/app:$(docker-image-tag)"
        ;;
    *)
        echo "Unable to deploy app: \"$app\"" 2>&1
        exit 1
        ;;
esac

PATH="$(dirname "$0")/vendor:$PATH"
export PATH

ecs-deploy \
    --cluster "$cluster" \
    --timeout 600 \
    --service-name "$service" \
    --image "$image"
