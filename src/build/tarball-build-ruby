#!/usr/bin/env bash
#/ Usage: ruby-tarball <image>
#/ Builds a tarball from a Ruby app container that is suitable for deployment
#/ and writes the pathname of the new tarball to standard output.
set -euo pipefail

image="$1"
test -z "$image" && {
  grep ^#/ < "$0" | cut -c4-
  exit 1
}

app_archive="$(mktemp -t"${image}XXXXX").tar"
bundle_archive="$(mktemp -t "${image}-bundleXXXXX").tar"
trap 'rm -f $bundle_archive' EXIT

docker run "$image" tar -C "/app" --exclude=".git" -cf - . \
    > "$app_archive"
docker run "$image" tar --xform="s,^./,./vendor/bundle/," \
    -C "/usr/local/bundle" -cf - . \
    > "$bundle_archive"
tar --concatenate --file "$app_archive" "$bundle_archive"

echo "$app_archive"
