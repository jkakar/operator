#!/usr/bin/env bash
set -eo pipefail

function usage() {
  echo "$0"
  echo
  echo "Cleans up Docker running containers and networks in preparation for a clean CI run"
}

if [ "$#" -gt 0 ]; then
  usage
  exit
fi

docker ps --format '{{.ID}}' | xargs -I% docker kill --signal=KILL %

COMPOSE_FILE="${COMPOSE_FILE-docker-compose.yml}"
if [ -f "$COMPOSE_FILE" ]; then
  docker-compose rm -fva
fi

# Workaround for <https://github.com/docker/libnetwork/issues/1113>
# Please remove when the bug is resolved, and a fixed version deployed
sudo /bin/systemctl restart docker.service
sleep 5
