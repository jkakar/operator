#!/usr/bin/env bash
#/ Usage: build-ruby my-great-project
#/ Build a BREAD Ruby project. It must be located under the src/ tree and have
#/ a valid docker-compose.yml configuration file at its root.
set -euo pipefail
cd "$(dirname "$0")/../.."

project="${1:-""}"
test -z "$project" && {
    grep ^#/ <"$0" |cut -c4-
    exit 1
}

dir="src/$project"
config="$dir/docker-compose.yml"

# Lint the code with RuboCop
docker-lint-ruby "$dir"

# Assume it's a Rails app if there's a docker-compose.yml file
if test -f "$config"
then
    docker-compose -p "$project" -f "$config" build --pull
    # TODO(sr) Remove the sleep test...
    docker-compose -p "$project" -f "$config" run app sleep 30
    docker-compose -p "$project" -f "$config" run app script/test
# Otherwise just build it as a normal Ruby library
else
    build-ruby-lib "$dir"
fi
