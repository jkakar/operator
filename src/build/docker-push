#!/usr/bin/env bash
#/ Usage: docker-push <image> <ecr-repo>
#/ Push a built Docker image to EC2 Container Service. Requires the AWS_PROFILE
#/ and AWS_DEFAULT_REGION environment variables to be set. AWS credentials must
#/ be configured in the /etc/aws/credentials file.
set -euo pipefail

: "${DEBUG:=""}"
test -n "$DEBUG" && set -x

awscredentials="/etc/aws/credentials"
if ! test -f "$awscredentials"
then
  echo "$awscredentials file is missing." 2>&1
  exit 1
fi

# On CI machines DOCKER_CONFIG is set to a directory that is not writable by
# the current user. This temporarily resets it to the normal location under
# the $HOME directory.
unset -v DOCKER_CONFIG

mkdir -p ~/.aws
cp /etc/aws/credentials ~/.aws/credentials
set +x
eval "$(aws ecr get-login)"
set -x

# shellcheck disable=SC2154
image="${2}:$(docker-image-tag)"
docker tag "$1" "$image"
docker push "$image"
