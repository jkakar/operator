#!/usr/bin/env bash
set -xeuo pipefail
dir="$1"
cd "$dir"

# Check for syntax error
find . -type f -name "*.rb" -print0 | xargs -0 ruby -c

rm -f Gemfile.lock
rm -rf .bundle
bundler install

if [ -d "test" ]; then
    find test -type f -name "*.rb" -print0 |
    xargs -0 bundler exec ruby -Ilib
elif [ -d "spec" ]; then
    bundle exec rspec spec
else
    echo "WARN: No test suite detected." 2>&1
fi
