#!/usr/bin/env bash
#/ Usage: tarball-upload <git-sha1> <build-green> <tarball>
#/ Appends build version file to the given tarball and uploads it to Artifactory.
#/ This requires the JFrog CLI to be available in the PATH.
set -euo pipefail
cd "$(dirname "$0")/../../.."

. etc/build/env

test $# -eq 3 || {
  grep ^#/ < "$0" | cut -c4-
  exit 1
}
sha1="${1:-""}"
green="${2:-"false"}"
tarball="${3:-""}"

# Append version file to the tarball
versionfile="build.version"
fileurl="${ARTIFACTORY_HOST}/api/storage/${ARTIFACTORY_REPO_CANOE}/"
fileurl="${fileurl}${CI_PLAN}/${CI_PLAN}-${CI_BUILD_NUMBER}.tar.tz"
printf "build%s\n%s\n%s\n" "${CI_BUILD_NUMBER}" "$sha1" "$fileurl" \
    > "$versionfile"
tar --append --file="$tarball" "$versionfile"

props="bambooProject=${CI_PROJECT};" \
    "bambooPlan=${CI_PLAN};" \
    "bambooJob=${BAMBOO_SHORT_JOB_KEY};" \
    "gitBranch=${CI_REPO_BRANCH_NAME};" \
    "gitRepo=${BAMBOO_REPO_URL};" \
    "gitSha=${sha1};" \
    "buildNumber=${CI_BUILD_NUMBER};" \
    "buildTimeStamp=${BAMBOO_BUILD_TIMESTAMP};" \
    "buildResults=${BAMBOO_BUILD_RESULTS_URL};" \
    "passedCI=${green};"

# Upload the tarball to Artifactory using the official CLI
jfrog rt upload \
    --url "$ARTIFACTORY_URL" \
    --user "$ARTIFACTORY_USERNAME" \
    --password "$ARTIFACTORY_PASSWORD" \
    --props  "$props" \
    "$tarball" \
    "${CANOE_ARTIFACTORY_REPO}/${CI_PLAN}/${CI_PLAN}-${CI_BUILD_NUMBER}.tar.gz"
