FROM golang:1.5
MAINTAINER Simon Rozet <me@simonrozet.com>
RUN \
  apt-get update -yq && \
  apt-get install -yq --no-install-recommends \
    autoconf \
    automake \
    build-essential \
    git \
    libtool \
    unzip && \
  apt-get clean && \
  rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*
RUN \
  wget https://codeload.github.com/google/protobuf/tar.gz/v3.0.0-beta-1 && \
  tar xvzf v3.0.0-beta-1 && \
  rm v3.0.0-beta-1 && \
  cd protobuf-3.0.0-beta-1 && \
  ./autogen.sh && \
  ./configure --prefix=/usr && \
  make && \
  make check && \
  make install && \
  cd - && \
  rm -rf protobuf-3.0.0-beta-1
RUN \
  git clone https://github.com/grpc/grpc.git && \
  cd grpc && \
  git reset --hard abf85d9 && \
  git submodule update --init && \
  make && \
  make install && \
  cd - && \
  rm -rf grpc
ENV GOROOT /usr/local/go
ENV GOBIN $GOPATH/bin
RUN mkdir -p $GOPATH/src/github.com/constabulary
RUN \
  git clone https://github.com/constabulary/gb \
		$GOPATH/src/github.com/constabulary/gb \
	&& cd $GOPATH/src/github.com/constabulary/gb \
	&& git reset --hard 7f23897 \
  && cd - \
	&& go install github.com/constabulary/gb/...
ENV OPERATORDIR /operator
ADD . $OPERATORDIR
RUN \
  cd $OPERATORDIR \
  && make -j3 \
    bin/protoc-gen-operatorcmd \
    bin/protoc-gen-operatorhubot \
    bin/protoc-gen-operatord
ENV PATH $OPERATORDIR/bin:$PATH
WORKDIR /data
VOLUME ["/data"]
