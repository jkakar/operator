#!/bin/sh
cd "$(dirname "$0")/.."
set -eu

: "${GOPATH:="$(pwd)/go"}"
PATH="$GOPATH/bin:/usr/bin:$PATH"
export GOPATH PATH
test -d "$GOPATH" || mkdir "$GOPATH"

test -n "$BUILDKITE_BUILD_NUMBER" &&
export VERSION="$BUILDKITE_BUILD_NUMBER"

git config --global url."https://sr:$GITHUB_REPO_TOKEN@github.com/".insteadOf "https://github.com/"

test -d "/opt/google-cloud-sdk" &&
PATH="/opt/google-cloud-sdk/bin:$PATH"
export PATH

go version
# TODO(sr) make build vet lint
# TODO(sr) make -j2 proto-cmd proto-operatord proto-hubot
make -j2 docker-build-hubot docker-build-operatord
make -j2 docker-push-operatord docker-push-hubot

buildkite-agent meta-data set "ci:images:hubot" "gcr.io/operator-europe-west1/hubot:$VERSION"
buildkite-agent meta-data set "ci:images:operatord" "gcr.io/operator-europe-west1/operatord:$VERSION"
