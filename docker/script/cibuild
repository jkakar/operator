#!/usr/bin/env bash
set -euo pipefail

: "${CI:="${bamboo_planRepository_branch}"}"

if [ -n "$CI" ]; then
  export DOCKER_CONFIG="/etc/docker"

  "$BAMBOO_CONFIGURATION_DIR"/bin/docker/cleanup -i
  eval "$("$BAMBOO_CONFIGURATION_DIR"/bin/docker/ssh-agent)"
fi

cd "$(cd "$(dirname "${BASH_SOURCE[0]}")/.."; pwd)"
head="$(git rev-parse HEAD)"
master="$(git rev-parse master || true)"

if [ -n "$CI" ]; then
  # On CI, this job only runs if something changed in the docker/ folder because
  # this is a very expensive build that also invalidates all of the existing
  # base images.
  if [ "${bamboo_repository_git_branch-}" = "master" ]; then
    revlist="${bamboo_repository_previous_revision_number}...${bamboo_repository_revision_number}"
  else
    revlist="master...${bamboo_repository_revision_number}"
  fi

  if ! git diff --name-only "$revlist" | grep -Eq '^docker/'; then
    echo "Nothing changed in docker/ since the previous build."
    echo "The Docker build does not need to run."
    exit 0
  fi

  export ARTIFACTORY_HOST="artifactory-internal.dev.pardot.com"
  # TODO: Replace with Vault when ready
  export GIT_DEV_TOKEN="${bamboo_git_dev_password_token}"

  if [ "$head" = "$master" ]; then
    export PUSH="yes"
  else
    echo "HEAD is ${head}, but master is ${master}. Skipping push." 2>&1
  fi
fi

exec rake
