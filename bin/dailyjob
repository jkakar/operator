#!/usr/bin/env bash
#/ Usage: dailyjob
#/ Script gets run daily via Bamboo. See https://bamboo.dev.pardot.com/browse/BREAD-DJ
set -euo pipefail
cd "$(dirname "$0")/.."

# Add artifactory utilities to our PATH
: "${BAMBOO_CONFIG_REPO:="$(pwd)/bamboo-configuration"}"
test -d "$BAMBOO_CONFIG_REPO/bin/artifactory" || {
    echo "dailyjob: Checkout of the Pardot/bamboo-configuration repo not" \
        "not found at $BAMBOO_CONFIG_REPO" 2>&1
    exit 1
}
PATH="$BAMBOO_CONFIG_REPO/bin/artifactory:$PATH"
export PATH

rm -f BREAD-GOL*.tar.gz jiracleaner
latest_build.rb --repo=pd-canoe --project=BREAD --plan=BREAD --job=GOL -d
tar -xvzf BREAD-GOL*.tar.gz jiracleaner

# Close stale JIRA tickets
jiracleaner \
    -project BREAD \
    -username breadbot \
    -password "$bamboo_BREADBOT_PASSWORD" \
    -apply
