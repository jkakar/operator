#!/usr/bin/env bash
#/ Usage: dailyjob
#/ Script gets run daily via Bamboo. See https://bamboo.dev.pardot.com/browse/BREAD-DJ
set -euo pipefail
cd "$(dirname "$0")/.."

docker build -f etc/docker/Dockerfile.build -t build/build .

# Compile jiracleaner program within a container
: ${TMPDIR:="/tmp"}
: ${GOOS:="linux"}
tmpdir="$(mktemp -d "buildXXXXX")"
trap 'rm -rf $tmpdir' EXIT
docker run --rm \
    -v "$(pwd):/go:ro" \
    -v "$(pwd)/${tmpdir}:/tmp" \
    -e "GOOS=${GOOS}" \
    -e "CGO_ENABLED=0" \
    build/build \
    go build -a -tags netgo -ldflags "-w" -o /tmp/jiracleaner bread/cmd/jiracleaner
    mv "${tmpdir}/jiracleaner" "$(pwd)/bin/jiracleaner"
PATH="$(pwd)/bin:$PATH"
export PATH

# Close stale JIRA tickets
# TODO(sr) Re-enable once https://jira.dev.pardot.com/browse/BREAD-963 is done
# jiracleaner \
#     -project BREAD \
#     -username breadbot \
#     -password "$bamboo_BREADBOT_PASSWORD" \
#     -apply
