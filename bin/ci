#!/bin/sh
cd "$(dirname "$0")/.."
set -eu

: "${GOPATH:="$(pwd)/go"}"
PATH="$GOPATH/bin:$PATH"
export GOPATH PATH
test -d "$GOPATH" || mkdir "$GOPATH"
GO15VENDOREXPERIMENT=1
export GO15VENDOREXPERIMENT

test -n "$BUILDKITE_BUILD_NUMBER" &&
export VERSION="$BUILDKITE_BUILD_NUMBER"

git config --global url."https://sr:$GITHUB_REPO_TOKEN@github.com/".insteadOf "https://github.com/"

make build install vet lint \
    proto-hubot proto-cmd proto-operatord

test -d "$(pwd)/google-cloud-sdk" &&
PATH="$(pwd)/google-cloud-sdk/bin:$PATH"
export PATH

make docker-build-hubot docker-build-operatord \
    docker-push-operatord docker-push-hubot
