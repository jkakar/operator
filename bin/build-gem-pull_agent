#!/usr/bin/env bash
#/ Usage: build-gem-pull_agent
#/ Build the pardot_pull-agent Ruby gem and push it to Artifactory. This is
#/ typically only invoked on the CI server. Requires the /etc/env/artifactoryenv
#/ file to be readable and to contain the hostname and authentication credentials
#/ of the Artifactory server.
set -euo pipefail

cd "$(dirname "$0")/../src/pull_agent"

# Configure RubyGems for pushing to our Artifactory repository
. /etc/env/artifactoryenv
RUBYGEMS_HOST="${PROTOCOL}://${ARTIFACTORYHOST}/artifactory/api/gems/pd-gem-local"
test -d "${HOME}/.gem" || mkdir "${HOME}/.gem"
curl -s -u "${USERNAME}:${PASSWORD}" "${RUBYGEMS_HOST}/api/v1/api_key.yaml" \
    > "${HOME}/.gem/credentials"
chmod 600 "${HOME}/.gem/credentials"
export RUBYGEMS_HOST

# Determine gem version. Bamboo does not provide a build number that is global
# accross branches. So we use the build number only when building the master
# branch. Otherwise we prefix the version by 0 to make sure that non-master
# builds are never considered newer. Example versions:
#
# * Master branch: pardot_pull-agent-123
# * Topic branch: pardot-pull_agent-0.PUL36.10
#
# One consequence of including the plan key (which includes letters) in the
# version string is that it is considered a prerelease version meaning that
# installing it requires passing the "--prerelease" flag to the "gem install"
# command. See this article for more info:
#
# http://guides.rubygems.org/patterns/#prerelease-gems
# shellcheck disable=SC2154
if [ "$bamboo_repository_branch_name" = "master" ]
then
    # shellcheck disable=SC2154
    RUBYGEM_VERSION="${bamboo_buildNumber}"
else
    RUBYGEM_VERSION="0.${bamboo_shortPlanKey}.${bamboo_buildNumber}"
fi
export RUBYGEM_VERSION
printf "Gem version: %s\n" "$RUBYGEM_VERSION"

# Build the gem and push it to Artifactory
gem build "pardot_pull-agent.gemspec"
gem push "pardot_pull-agent-${RUBYGEM_VERSION}.gem"
