<h1><i class="icon-train2"></i> DEPLOY</h1>
<p class="lead no-bottom">
  <% if @watching %>
    <i class="icon-eye-open"></i> Watching deploy of
  <% end %>
  <%= current_deploy.repo_name.capitalize %> :
  <%= print_deploy_what(current_deploy) %>
  to <%= current_deploy.deploy_target.name.capitalize %>
</p>
<small class="muted">
  Started on <%= print_time current_deploy.created_at %> by
  <% if current_deploy.auth_user == current_user %>
    <strong>you</strong>.
  <% else %>
    <%= print_email current_deploy.auth_user.email %>.
  <% end %>
</small>
<br><br>

<% if current_deploy.canceled? %>
  <div class="alert alert-danger">
    <i class="icon-remove-sign"></i>
    <strong>Canceled</strong>:
    this deploy was canceled and marked completed on <%= print_time current_deploy.updated_at %>
  </div>
<% elsif current_deploy.completed? %>
  <div class="alert alert-success">
    <i class="icon-check"></i>
    <strong>Complete</strong>:
    marked as completed on <%= print_time current_deploy.updated_at %>
  </div>
<% else %>
  <div class="alert alert-warning">
    <img src="/img/busy.gif" style="width:25px;">
    <strong>Not Complete</strong>: we're waiting on this <i class="icon-train2"></i> to stop.
    <% if @watching && !current_deploy.completed? %>
      <script type="text/javascript">
        // automatically refresh the page every 10 secs
        setTimeout(function () { location.reload(); }, 10000);
      </script>
    <% end %>
    <p class="muted"><strong>Process ID:</strong> <%= current_deploy.process_id %></p>
  </div>

  <div class="deploy-progress">
    <div class="deploy-progress-percentage" style="width:<%= current_deploy.percentage_complete %>%">
      <%= current_deploy.percentage_complete %>%&nbsp;
    </div>
  </div>
<% end %>

<h4>Log</h4>
<%= partial :'partials/deploy_log' %>


<% # ======================== SERVERS ======================== %>
<%= partial :'partials/deploy_servers' %>
<div class="alert alert-info" role="alert">
  <% if current_deploy.used_all_servers? %>
    <p class="muted">
      <em>All servers used for sync.</em>
    </p>
  <% else %>
    <p>
      <strong>Specified Servers:</strong>
      <%= current_deploy.specified_servers %>
    </p>
  <% end %>
</div>

<% # ======================== ACTION BUTTONS ======================== %>
<% if !@watching && !current_deploy.completed? %>
  <br>
  <div>
    <form class="js-confirm" role="form" action="/deploy/<%= current_deploy.id %>/mark/complete" method="post" data-confirm="Are you sure you want to mark this complete?">
      <button type="submit" class="btn btn-danger">Mark as Complete</button>
    </form>
  </div>
<% end %>

<hr>
<% if current_deploy.completed? %>
  <div>
    <form class="form-inline" role="form" action="<%= deploy_target_path(current_deploy.deploy_target, nil) %>" method="post">
      <button type="submit" class="btn btn-warning"><i class="icon-train2"></i> REDEPLOY THIS!</button>
    </form>
  </div>
<% else %>
  <div>
    <form class="js-confirm" role="form" action="/deploy/<%= current_deploy.id %>/cancel" method="post" data-confirm="Are you sure you want to cancel this deploy?">
      <button type="submit" class="btn btn-danger"><i class="icon-remove-sign"></i> CANCEL</button>
    </form>
  </div>
<% end %>

<br>
