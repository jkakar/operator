# Privet

Privet is a tool to parallelize a test suite. Given a list of tests to run—and optionally, information about a previous test run—it will create a plan to execute those tests on an arbitrary number of workers.

Privet has two main subcommands: plan and execute. The plan command produces a JSON file that describes tests to be run, split up into chunks by worker. The execute command ingests a plan JSON file and executes test chunks for a given worker.

It might be easier to understand with a hypothetical example:

To create a plan, Privet requires a list of test files to be run. This list can be generated by whatever is appropriate for your setup. An example manifest might look like:

```
{"filename": "path/to/test1.php", "suite": "foo", "fingerprint": "b5bb9d8014a0f9b1d61e21e796d78dccdf1352f23cd32812f4850b878ae4944c"}
{"filename": "path/to/test2.php", "suite": "foo", "fingerprint": "c739918a22764c87ac849e5c5ab4a681ca6d19c2748e434e1817df436b671f81"}
{"filename": "path/to/test2.php", "suite": "foo", "fingerprint": "9f767b0b078d25ab01b7e887c3abe03df60943d2b7f4a6fb218e99685db3b30a"}
"}
```

The keys for each line of JSON are:
* `filename`: The name of the file, corresponding to names of files in the JUnit results (if present, described later).
* `suite`: A string that can isolate tests from one another. Privet will not run files in different suites in the same run.
* `fingerprint`: A fingerprint (typically a SHA sum) of the file as it currently exists. If it differs from the SHA sum saved from the previous results, Privet will know it cannot trust the JUnit reuslts (if present, described later) to have every test represented.

With this test manifest, Privet can generate a plan:

```
privet \
  -test-manifest="/path/to/test/manifest/file.txt" \
  -num-workers="15" \
  -target-duration="30s"
  plan
```

Optionally, a directory containing results from a previous build can be specified using the `-previous-results-dir` option. If present, Privet will use timing information from the previous results to split the tests in more evenly timed chunks. Right now, only JUnit formatted results are supported, but support for other formats could be added. If present, a `SHASUMS` file in that directory will be compared against each test file's `fingerprint` value (from earlier).

The plan is generally uploaded to some shared location (for Pardot, the pd-build-plans repository on https://artifactory.dev.pardot.com) and downloaded by each test worker. Given the plan, each worker uses Privet to execute the plan:

```
privet \
  -plan-file="/path/to/plan/file.json" \
  -worker="0" \
  -parallelism="4" \
  -command-path="/path/to/command/that/runs/tests"
```

The command given in `command-path` will be executed for each test chunk. The tests that should be run will be streamed into the command's standard input in the format:

```json
{
  "test_executions": [
    {
      "filename": "/path/to/test1.php",
      "test_case_names": ["test1", "test2"]
    },
    {
      "filename": "/path/to/test2.php"
    }
  ]
}
```

The `command-path` command is responsible for running those tests (and only those tests!) and making the results available to the CI system.
